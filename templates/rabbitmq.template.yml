env:
  HOME: /var/lib/rabbitmq
  RABBITMQ_NODE_IP_ADDRESS: 127.0.0.1
  RABBITMQ_NODE_PORT: 5672
  RABBITMQ_LOG_BASE: /var/log/rabbitmq

run:
  - exec:
      cmd:
        - mkdir -p /var/log/rabbitmq
        - chown -R rabbitmq /var/log/rabbitmq
        - chgrp -R rabbitmq /var/log/rabbitmq

  - file:
     path: /etc/rabbitmq/rabbitmq.config
     contents: |
         %% -*- mode: erlang -*-
         %% See http://www.rabbitmq.com/configure.html for details.
         %% ----------------------------------------------------------------------------
         [
          {rabbit,
           [{log_levels, [{connection, info}]}]
          }
         ].

  - file:
     path: /etc/service/rabbitmq/run
     chmod: "+x"
     contents: |
        #!/bin/sh
        exec 2>&1

        ulimit -n 102400

        exec chpst -u rabbitmq -U rabbitmq /usr/sbin/rabbitmq-server -detached

  - file:
     path: /etc/runit/3.d/99-rabbitmq
     chmod: "+x"
     contents: |
       #!/bin/bash
       sv stop rabbitmq

# launch rabbitmq if needed
hooks:
  after_code:
    - replace:
       filename: /etc/service/rabbitmq/run
       from: "# rabbitmq"
       to: sv start rabbitmq || exit 1
