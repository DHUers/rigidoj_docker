env:
   #RABBITMQ_HOME: /var/lib/rabbitmq
   RABBITMQ_LOG_BASE: /var/log/rabbitmq

run:
  - exec:
      cmd:
        - mkdir -p $RABBITMQ_LOG_BASE
        - chown -R rabbitmq:rabbitmq $RABBITMQ_LOG_BASE
        # - echo "dhakhjag" > /root/.erlang.cookie
        # # - chown rabbitmq:rabbitmq /root/.erlang.cookie
        # - chmod 777 -R /root

  - file:
     path: /etc/rabbitmq/rabbitmq.config
     contents: |
         %% -*- mode: erlang -*-
         %% See http://www.rabbitmq.com/configure.html for details.
         %% ----------------------------------------------------------------------------
         [
          {rabbit,
           [{log_levels, [{connection, info}]}]
          }
         ].

  - file:
     path: /etc/service/rabbitmq/run
     chmod: "+x"
     contents: |
        #!/bin/sh
        exec 2>&1

        ulimit -n 102400

        # exec chpst -u rabbitmq -U rabbitmq /usr/sbin/rabbitmq-server -detached
        exec chpst -u root -U root /usr/sbin/rabbitmq-server -detached

  - file:
     path: /etc/runit/3.d/99-rabbitmq
     chmod: "+x"
     contents: |
       #!/bin/bash
       sv stop rabbitmq
